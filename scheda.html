<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheda Esploratore - Scout App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'scout-green': '#2D5016',
                        'scout-blue': '#1E40AF',
                        'scout-orange': '#EA580C'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <button onclick="goBack()" class="mr-4 p-2 rounded-lg hover:bg-gray-100 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h1 id="pageTitle" class="text-xl font-bold text-gray-900">Scheda Esploratore</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="editToggle" class="bg-scout-green text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors hidden">
                        Modifica
                    </button>
                    <button id="saveButton" class="bg-scout-blue text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors hidden">
                        Salva
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Dati Anagrafici -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-scout-green" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                    </svg>
                    Dati Anagrafici
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                        <input type="text" id="nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Cognome</label>
                        <input type="text" id="cognome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data di nascita</label>
                        <input type="date" id="dataNascita" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Codice Fiscale</label>
                        <input type="text" id="codiceFiscale" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Indirizzo</label>
                        <input type="text" id="indirizzo" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contatti -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-scout-green" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                    </svg>
                    Contatti
                </h2>
            </div>
            <div class="p-6 space-y-6">
                <!-- Genitore 1 -->
                <div>
                    <h3 class="text-md font-medium text-gray-800 mb-4">Genitore 1</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                            <input type="text" id="genitore1Nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="genitore1Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                            <div class="flex space-x-2">
                                <input type="tel" id="genitore1Telefono" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                                <button onclick="callPhone('genitore1Telefono')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                    </svg>
                                </button>
                                <button onclick="openWhatsApp('genitore1Telefono')" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.886 3.488"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Genitore 2 -->
                <div>
                    <h3 class="text-md font-medium text-gray-800 mb-4">Genitore 2</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nome</label>
                            <input type="text" id="genitore2Nome" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="genitore2Email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                            <div class="flex space-x-2">
                                <input type="tel" id="genitore2Telefono" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                                <button onclick="callPhone('genitore2Telefono')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                    </svg>
                                </button>
                                <button onclick="openWhatsApp('genitore2Telefono')" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.886 3.488"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Esploratore -->
                <div>
                    <h3 class="text-md font-medium text-gray-800 mb-4">Esploratore</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="esploratoreEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Telefono</label>
                            <div class="flex space-x-2">
                                <input type="tel" id="esploratoreTelefono" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                                <button onclick="callPhone('esploratoreTelefono')" class="bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                                    </svg>
                                </button>
                                <button onclick="openWhatsApp('esploratoreTelefono')" class="bg-green-600 text-white p-2 rounded-lg hover:bg-green-700 transition-colors">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.886 3.488"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informazioni Sanitarie -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-scout-green" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h4a1 1 0 010 2H6.414l2.293 2.293a1 1 0 01-1.414 1.414L5 6.414V8a1 1 0 01-2 0V4zm9 1a1 1 0 010-2h4a1 1 0 011 1v4a1 1 0 01-2 0V6.414l-2.293 2.293a1 1 0 11-1.414-1.414L13.586 5H12zm-9 7a1 1 0 012 0v1.586l2.293-2.293a1 1 0 111.414 1.414L6.414 15H8a1 1 0 010 2H4a1 1 0 01-1-1v-4zm13-1a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 010-2h1.586l-2.293-2.293a1 1 0 111.414-1.414L15.586 13V12a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                    Informazioni Sanitarie
                </h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Gruppo Sanguigno</label>
                        <input type="text" id="gruppoSanguigno" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Intolleranze Alimentari</label>
                        <div class="flex space-x-2">
                            <textarea id="intolleranze" rows="3" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                            <button onclick="copyToClipboard('intolleranze')" class="bg-gray-500 text-white p-2 rounded-lg hover:bg-gray-600 transition-colors self-start">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                                    <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Certificazioni</label>
                        <textarea id="certificazioni" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vaccinazioni</label>
                        <textarea id="vaccinazioni" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Allergie</label>
                        <textarea id="allergie" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Farmaci</label>
                        <textarea id="farmaci" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Note Sanitarie</label>
                        <textarea id="noteSanitarie" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-scout-green focus:border-transparent" readonly></textarea>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl p-8 flex items-center space-x-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-scout-green"></div>
            <span class="text-lg font-medium">Caricamento...</span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBofskY5y_scMtgRnQi2WXHoyUyO2522CM",
            authDomain: "appreparto-ce9f3.firebaseapp.com",
            projectId: "appreparto-ce9f3",
            storageBucket: "appreparto-ce9f3.firebasestorage.app",
            messagingSenderId: "456787780780",
            appId: "1:456787780780:web:860f2b52f6b1c636ce2b09"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let targetUserId = null;
        let isEditing = false;
        let canEdit = false;

        // Get user ID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        targetUserId = urlParams.get('id');

        if (!targetUserId) {
            window.location.href = 'dashboard.html';
        }

        // Verifica autenticazione
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, 'utenti', user.uid));
                if (userDoc.exists()) {
                    currentUser = userDoc.data();
                    currentUser.uid = user.uid;
                    
                    // Determina se l'utente puÃ² modificare
                    canEdit = (currentUser.ruolo === 'staff' && currentUser.approvato) || currentUser.uid === targetUserId;
                    
                    if (canEdit && currentUser.ruolo === 'staff') {
                        document.getElementById('editToggle').classList.remove('hidden');
                    }
                    
                    await loadUserData();
                } else {
                    window.location.href = 'login.html';
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadUserData() {
            try {
                const userDoc = await getDoc(doc(db, 'utenti', targetUserId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    
                    // Aggiorna il titolo della pagina
                    document.getElementById('pageTitle').textContent = `Scheda di ${userData.nome} ${userData.cognome}`;
                    
                    // Popola i campi
                    populateFields(userData);
                    
                    document.getElementById('loading').style.display = 'none';
                } else {
                    alert('Utente non trovato');
                    window.location.href = 'dashboard.html';
                }
            } catch (error) {
                console.error('Errore nel caricamento dati:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function populateFields(userData) {
            // Dati anagrafici
            document.getElementById('nome').value = userData.nome || '';
            document.getElementById('cognome').value = userData.cognome || '';
            document.getElementById('email').value = userData.email || '';
            document.getElementById('dataNascita').value = userData.datiScheda?.dataNascita || '';
            document.getElementById('codiceFiscale').value = userData.datiScheda?.codiceFiscale || '';
            document.getElementById('indirizzo').value = userData.datiScheda?.indirizzo || '';
            
            // Contatti
            const contatti = userData.datiScheda?.contatti || {};
            document.getElementById('genitore1Nome').value = contatti.genitore1?.nome || '';
            document.getElementById('genitore1Email').value = contatti.genitore1?.email || '';
            document.getElementById('genitore1Telefono').value = contatti.genitore1?.telefono || '';
            document.getElementById('genitore2Nome').value = contatti.genitore2?.nome || '';
            document.getElementById('genitore2Email').value = contatti.genitore2?.email || '';
            document.getElementById('genitore2Telefono').value = contatti.genitore2?.telefono || '';
            document.getElementById('esploratoreEmail').value = contatti.esploratore?.email || userData.email || '';
            document.getElementById('esploratoreTelefono').value = contatti.esploratore?.telefono || '';
            
            // Informazioni sanitarie
            const sanitarie = userData.datiScheda?.sanitarie || {};
            document.getElementById('gruppoSanguigno').value = sanitarie.gruppoSanguigno || '';
            document.getElementById('intolleranze').value = sanitarie.intolleranze || '';
            document.getElementById('certificazioni').value = sanitarie.certificazioni || '';
            document.getElementById('vaccinazioni').value = sanitarie.vaccinazioni || '';
            document.getElementById('allergie').value = sanitarie.allergie || '';
            document.getElementById('farmaci').value = sanitarie.farmaci || '';
            document.getElementById('noteSanitarie').value = sanitarie.note || '';
        }

        // Edit toggle
        document.getElementById('editToggle').addEventListener('click', () => {
            if (!canEdit) return;
            
            isEditing = !isEditing;
            toggleEditMode();
        });

        function toggleEditMode() {
            const inputs = document.querySelectorAll('input, textarea');
            const editButton = document.getElementById('editToggle');
            const saveButton = document.getElementById('saveButton');
            
            inputs.forEach(input => {
                if (input.id !== 'email') { // Email sempre readonly
                    input.readOnly = !isEditing;
                    if (isEditing) {
                        input.classList.remove('bg-gray-50');
                        input.classList.add('bg-white');
                    } else {
                        input.classList.remove('bg-white');
                        input.classList.add('bg-gray-50');
                    }
                }
            });
            
            if (isEditing) {
                editButton.textContent = 'Annulla';
                editButton.classList.remove('bg-scout-green', 'hover:bg-green-700');
                editButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
                saveButton.classList.remove('hidden');
            } else {
                editButton.textContent = 'Modifica';
                editButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                editButton.classList.add('bg-scout-green', 'hover:bg-green-700');
                saveButton.classList.add('hidden');
            }
        }

        // Save button
        document.getElementById('saveButton').addEventListener('click', async () => {
            try {
                const updatedData = {
                    nome: document.getElementById('nome').value,
                    cognome: document.getElementById('cognome').value,
                    datiScheda: {
                        dataNascita: document.getElementById('dataNascita').value,
                        codiceFiscale: document.getElementById('codiceFiscale').value,
                        indirizzo: document.getElementById('indirizzo').value,
                        contatti: {
                            genitore1: {
                                nome: document.getElementById('genitore1Nome').value,
                                email: document.getElementById('genitore1Email').value,
                                telefono: document.getElementById('genitore1Telefono').value
                            },
                            genitore2: {
                                nome: document.getElementById('genitore2Nome').value,
                                email: document.getElementById('genitore2Email').value,
                                telefono: document.getElementById('genitore2Telefono').value
                            },
                            esploratore: {
                                email: document.getElementById('esploratoreEmail').value,
                                telefono: document.getElementById('esploratoreTelefono').value
                            }
                        },
                        sanitarie: {
                            gruppoSanguigno: document.getElementById('gruppoSanguigno').value,
                            intolleranze: document.getElementById('intolleranze').value,
                            certificazioni: document.getElementById('certificazioni').value,
                            vaccinazioni: document.getElementById('vaccinazioni').value,
                            allergie: document.getElementById('allergie').value,
                            farmaci: document.getElementById('farmaci').value,
                            note: document.getElementById('noteSanitarie').value
                        }
                    }
                };
                
                // Mantieni i dati esistenti non modificati
                const currentDoc = await getDoc(doc(db, 'utenti', targetUserId));
                const currentData = currentDoc.data();
                
                const mergedData = {
                    ...currentData,
                    ...updatedData,
                    datiScheda: {
                        ...currentData.datiScheda,
                        ...updatedData.datiScheda,
                        contatti: {
                            ...currentData.datiScheda?.contatti,
                            ...updatedData.datiScheda.contatti
                        },
                        sanitarie: {
                            ...currentData.datiScheda?.sanitarie,
                            ...updatedData.datiScheda.sanitarie
                        }
                    }
                };
                
                await updateDoc(doc(db, 'utenti', targetUserId), mergedData);
                
                isEditing = false;
                toggleEditMode();
                
                // Toast di successo
                showToast('Dati salvati con successo!', 'success');
                
            } catch (error) {
                console.error('Errore nel salvataggio:', error);
                showToast('Errore nel salvataggio dei dati', 'error');
            }
        });

        // Utility functions
        window.callPhone = (inputId) => {
            const phone = document.getElementById(inputId).value;
            if (phone) {
                window.location.href = `tel:${phone}`;
            }
        };

        window.openWhatsApp = (inputId) => {
            const phone = document.getElementById(inputId).value;
            if (phone) {
                const cleanPhone = phone.replace(/\D/g, '');
                window.open(`https://wa.me/${cleanPhone}`, '_blank');
            }
        };

        window.copyToClipboard = async (inputId) => {
            const text = document.getElementById(inputId).value;
            if (text) {
                try {
                    await navigator.clipboard.writeText(text);
                    showToast('Copiato negli appunti!', 'success');
                } catch (err) {
                    console.error('Errore nella copia:', err);
                    showToast('Errore nella copia', 'error');
                }
            }
        };

        window.goBack = () => {
            window.location.href = 'dashboard.html';
        };

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-lg transform translate-x-full transition-transform duration-300 z-50 ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        ${type === 'success' 
                            ? '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>'
                            : '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>'
                        }
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
